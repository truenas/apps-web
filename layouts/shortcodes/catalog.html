<!-- Search and Filter Controls -->
<div class="catalog-search-container">
  <select id="catalog-filter">
    <option value="">Categories: All</option>
  </select>
  <input
    type="text"
    id="catalog-search"
    placeholder="Filter apps..."
    onkeyup="filterCatalog()"
  />
</div>

<!-- Catalog Cards -->
<div class="docs-sections" id="catalog-cards">
  {{- $telemetryURL := "https://telemetry.sys.truenas.net/apps/truenas-apps-stats.json" -}} <!-- Telemetry data URL -->
  {{- $rawData := resources.GetRemote $telemetryURL -}} <!-- Fetch telemetry data -->
  {{- $telemetryData := $rawData | transform.Unmarshal -}} <!-- Parse telemetry data -->
  {{- $localBaseDir := "Apps_Temp/trains" -}} <!-- Base directory for temporary files -->
  {{- $categories := dict "Community-Apps" "community" "Enterprise-Apps" "enterprise" "Stable-Apps" "stable" -}} <!-- Map categories to subdirectories -->
  {{- $allCategories := slice -}} <!-- Initialize a slice to collect all categories -->

  {{- range .Page.Pages -}} <!-- Loop through all pages under the current directory -->
    {{- $category := .Section -}} <!-- Get the section name (e.g., Community-Apps, Enterprise-Apps, Stable-Apps) -->
    {{- $subDir := index $categories $category -}} <!-- Map the section to the corresponding subdirectory -->
    {{- $path := printf "%s/%s/%s/app_versions.json" $localBaseDir $subDir .File.BaseFileName -}} <!-- Construct the file path -->
    {{- $appMetadata := dict -}} <!-- Initialize app metadata -->
    {{- $appIcon := "/images/default-icon.png" -}} <!-- Default icon -->
    {{- $appDescription := "Learn more about this app." -}} <!-- Default description -->
    {{- $deploymentCount := 0 -}} <!-- Initialize deployment count -->
    {{- $appCategories := slice -}} <!-- Initialize app categories -->

    <!-- Check if the file exists -->
    {{- if fileExists $path -}}
      {{- $fileContent := readFile $path -}} <!-- Read the JSON file -->
      {{- $jsonData := transform.Unmarshal $fileContent -}} <!-- Parse the JSON file -->

      <!-- Extract app metadata -->
      {{- $firstKey := "" -}}
      {{- range $key, $value := $jsonData -}}
        {{- $firstKey = $key -}}
        {{- break -}}
      {{- end -}}
      {{- $versionData := index $jsonData $firstKey -}}
      {{- $appMetadata = index $versionData "app_metadata" -}}
      {{- $appIcon = index $appMetadata "icon" | default "/images/default-icon.png" -}}
      {{- $appDescription = index $appMetadata "description" | default "Learn more about this app." -}}
      {{- $appCategories = index $appMetadata "categories" | default (slice) -}} <!-- Extract categories -->

      <!-- Collect categories for the dropdown -->
      {{- $allCategories = $allCategories | union $appCategories -}} <!-- Add categories to the global list -->

      <!-- Get deployment count from telemetry data -->
      {{- $appName := index $appMetadata "name" -}}
      {{- $telemetryGroup := index $telemetryData $category -}}
      {{- if $telemetryGroup -}}
        {{- $deploymentCount = index $telemetryGroup $appName | default 0 -}}
      {{- end -}}
    {{- else -}}
      {{ warnf "File not found: %s" $path }}
    {{- end -}}

    <!-- Render the app card -->
    <a class="section-box catalog-card" href="{{ .RelPermalink }}" data-title="{{ .Title | lower }}" data-categories="{{ delimit $appCategories "," }}">
      <!-- Inline Award for active use callouts -->
      {{ if gt $deploymentCount 0 }}
      <div class="popular-app">
        {{ if gt $deploymentCount 20000 }}
          <img src="/images/Gold-Labeled.png" alt="20,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
        {{ else if gt $deploymentCount 10000 }}
          <img src="/images/Silver-Labeled.png" alt="10,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
        {{ else if gt $deploymentCount 5000 }}
          <img src="/images/Bronze-Labeled.png" alt="5,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
        {{ else if gt $deploymentCount 1000 }}
          <img src="/images/Ribbon-Labeled.png" alt="1000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
        {{ end }}
      </div>
      {{ end }}
      <div class="box-image">
        <img class="app-card-img" src="{{ $appIcon }}" aria-label="{{ .Title }} Logo">
      </div>
      <div class="section-tab-content ixprods">
        <b style="justify-content:center;font-size:1.5rem;font-weight:600;">{{ .Title }}</b>
        <p>{{ $appDescription }}</p>
      </div>
    </a>
  {{- end -}}
</div>

<!-- Populate the Dropdown with Categories -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    try {
      // Populate the dropdown with categories
      const categories = JSON.parse('{{ $allCategories | jsonify }}');
      const dropdown = document.getElementById("catalog-filter");
      if (Array.isArray(categories)) {
        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.toLowerCase();
          option.textContent = category;
          dropdown.appendChild(option);
        });
      } else {
        console.error("Categories is not an array:", categories);
      }
    } catch (error) {
      console.error("Error parsing categories:", error);
    }

    // Add event listeners for filtering
    const searchInput = document.getElementById("catalog-search");
    const filterDropdown = document.getElementById("catalog-filter");

    if (searchInput) {
      searchInput.addEventListener("keyup", filterCatalog);
    } else {
      console.error("Search input not found in the DOM.");
    }

    if (filterDropdown) {
      filterDropdown.addEventListener("change", filterCatalog);
    } else {
      console.error("Filter dropdown not found in the DOM.");
    }
  });

  function filterCatalog() {
    const input = document.getElementById("catalog-search")?.value.toLowerCase() || "";
    const filter = document.getElementById("catalog-filter")?.value.toLowerCase() || "";
    const cards = document.querySelectorAll(".catalog-card");

    if (!cards || cards.length === 0) {
      console.error("No catalog cards found for filtering.");
      return;
    }

    cards.forEach((card) => {
      if (!card || !(card instanceof HTMLElement)) {
        console.error("Invalid card element:", card);
        return;
      }

      const title = card.getAttribute("data-title") || "";
      const categories = card.getAttribute("data-categories") || "";

      const matchesSearch = title.toLowerCase().includes(input);
      const matchesFilter = !filter || categories.toLowerCase().includes(filter);

      if (matchesSearch && matchesFilter) {
        card.style.display = "block";
      } else {
        card.style.display = "none";
      }
    });
  }
</script>