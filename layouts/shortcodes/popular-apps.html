{{ $telemetryURL := "https://telemetry.sys.truenas.net/apps/truenas-apps-stats.json" }}
{{ $rawData := resources.GetRemote $telemetryURL }}
{{ $telemetryData := $rawData | transform.Unmarshal }}
{{ $localBaseDir := "Apps_Temp/trains" }}

<!-- Capture the current date and time -->
{{ $reviewedAt := now | time.Format "January 2, 2006" }}

<!-- Flatten all apps across all trains -->
{{ $allApps := slice }}
{{ range $train, $apps := $telemetryData }}
  {{ range $name, $count := $apps }}
    <!-- Skip "custom-app" to avoid duplicate cards -->
    {{ if eq $name "custom-app" }}
      {{ continue }}
    {{ end }}
    {{ $allApps = $allApps | append (dict "name" $name "count" $count "train" $train) }}
  {{ end }}
{{ end }}

<!-- Sort all apps by deployment count in descending order -->
{{ $sortedApps := sort $allApps "count" "desc" }}

<!-- Dropdown for selecting the number of apps to display -->
<div class="popular-list-dropdown">
  <span>
    Here are the most popular and active TrueNAS apps, as of {{ $reviewedAt }}!
  </span>
  <select id="app-count-select" onchange="updateAppDisplay()" class="filter-apps">
    <option value="10" selected>Top 10</option>
    <option value="25">Top 25</option>
    <option value="50">Top 50</option>
  </select>
</div>

<!-- Container for app cards -->
<div id="app-cards-container" class="docs-sections">
  <!-- Render all apps but hide them initially with a data attribute -->
  {{ range $index, $app := $sortedApps }}
    {{ $appName := $app.name }}
    {{ $deploymentCount := $app.count }}
    {{ $appTrain := $app.train }}
    {{ $localFilePath := printf "%s/%s/%s/app_versions.json" $localBaseDir (lower $appTrain) $appName }}

    <!-- Initialize app metadata -->
    {{ $appTitle := "" }}
    {{ $appDescription := "" }}
    {{ $appIcon := "" }}

    <!-- Check if the file exists -->
    {{ if fileExists $localFilePath }}
      <!-- Read and parse the JSON file -->
      {{ $fileContent := readFile $localFilePath }}
      {{ $jsonData := transform.Unmarshal $fileContent }}

      <!-- Extract app metadata -->
      {{ range $version, $data := $jsonData }}
        {{ $appTitle = index $data "app_metadata" "title" }}
        {{ $appDescription = index $data "app_metadata" "description" }}
        {{ $appIcon = index $data "app_metadata" "icon" }}
        {{ break }}
      {{ end }}
    {{ end }}

    <!-- Render the app card -->
    <a class="section-box app-card" href="/catalog/{{ $appName | urlize }}/" data-index="{{ $index }}">
      <!-- Inline Award for active use callouts -->
      {{ if gt $deploymentCount 0 }}
      <div class="popular-app">
        {{ if gt $deploymentCount 20000 }}
        <img src="/images/Gold-Labeled.png" alt="20,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
        {{ else if gt $deploymentCount 10000 }}
        <img src="/images/Silver-Labeled.png" alt="10,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
        {{ else if gt $deploymentCount 5000 }}
        <img src="/images/Bronze-Labeled.png" alt="5,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
        {{ else if gt $deploymentCount 1000 }}
        <img src="/images/Ribbon-Labeled.png" alt="1000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
        {{ end }}
      </div>
      {{ end }}
      <div class="box-image">
        <img class="app-card-img" src="{{ $appIcon | default "/images/default-icon.png" }}" aria-label="{{ $appTitle | default ($appName | title) }} Logo">
      </div>
      <div class="section-tab-content ixprods">
        <b style="justify-content:center;font-size:1.5rem;font-weight:600;">{{ $appTitle | default ($appName | title) }}</b>
        <br>Train: {{ $appTrain | default "Unknown" }}<br>
        <p>{{ $appDescription | default (printf "Learn more about %s and its features." ($appName | title)) }}</p>
      </div>
    </a>
  {{ end }}
</div>

<!-- JavaScript to handle dropdown selection -->
<script>
  function updateAppDisplay() {
    const selectedCount = parseInt(document.getElementById('app-count-select').value, 10);
    const appCards = document.querySelectorAll('.app-card');

    appCards.forEach((card, index) => {
      if (index < selectedCount) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  }

  // Initialize the display to show the default "Top 10"
  document.addEventListener('DOMContentLoaded', () => {
    updateAppDisplay();
  });
</script>