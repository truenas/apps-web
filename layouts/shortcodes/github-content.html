<!-- Define variables -->
{{ $path := .Get "path" }}
{{ $localBaseDir := "Apps_Temp" }} <!-- Base directory for trains -->
{{ $localFilePath := printf "%s/%s" $localBaseDir $path }} <!-- Corrected file path -->
{{ $editUrl := printf "https://github.com/truenas/apps/edit/master/trains/%s" $path }}

<!-- Check if the file exists locally -->
{{ if fileExists $localFilePath }}
  <!-- Read and parse the JSON file -->
  {{ $fileContent := readFile $localFilePath }}
  {{ $jsonData := transform.Unmarshal $fileContent | default dict }}

  <!-- Ensure jsonData is valid before proceeding -->
  {{ if $jsonData }}
    <!-- Extract the first key dynamically -->
    {{ $firstKey := "" }}
    {{ range $key, $value := $jsonData }}
      {{ $firstKey = $key }}
      {{ break }}
    {{ end }}
    {{ $versionData := index $jsonData $firstKey | default dict }}

    <!-- Extract metadata -->
    {{ $name := $versionData.app_metadata.name | default "" }}
    {{ $train := $versionData.app_metadata.train | lower | default "" }}
    {{ $appTitle := $versionData.app_metadata.title | default "App Title" }}
    {{ $appDescription := $versionData.app_metadata.description | default "No description available." }}
    {{ $appIcon := $versionData.app_metadata.icon | default "/images/default-icon.png" }}
    {{ $minScaleVersion := $versionData.app_metadata.annotations.min_scale_version | default "" }}
    {{ $changelog := $versionData.app_metadata.changelog_url | default "" }}
    {{ $added := $versionData.app_metadata.date_added | default "" }}
    {{ $keywords := $versionData.app_metadata.keywords | default (slice) }}
    {{ .Page.Scratch.Set "keywords" $keywords }}

    <!-- Logging for missing fields -->
    {{ if not $name }}
      {{ warnf "Missing 'name' in app_metadata for file: %s" $localFilePath }}
    {{ end }}
    {{ if not $train }}
      {{ warnf "Missing 'train' in app_metadata for file: %s" $localFilePath }}
    {{ end }}
    {{ if eq $appTitle "App Title" }}
      {{ warnf "Missing 'title' in app_metadata for file: %s" $localFilePath }}
    {{ end }}
    {{ if eq $appDescription "No description available." }}
      {{ warnf "Missing 'description' in app_metadata for file: %s" $localFilePath }}
    {{ end }}
    {{ if eq $appIcon "/images/default-icon.png" }}
      {{ warnf "Missing or default 'icon' in app_metadata for file: %s" $localFilePath }}
    {{ end }}
    {{ if not $added }}
      {{ warnf "Missing 'date_added' in app_metadata for file: %s" $localFilePath }}
    {{ end }}
    {{ if not (isset $versionData.app_metadata "keywords") }}
      {{ warnf "Missing 'keywords' in app_metadata for file: %s" $localFilePath }}
    {{ end }}
    {{ if not (isset $versionData.app_metadata "changelog_url") }}
      {{ warnf "Missing 'changelog_url' in app_metadata for file: %s" $localFilePath }}
    {{ end }}
    {{ if not (isset $versionData.app_metadata "home") }}
      {{ warnf "Missing 'home' in app_metadata for file: %s" $localFilePath }}
    {{ end }}

    <!-- Render the content -->
    <div class="apps-docs-sections">
      <!-- First Card -->
      <div class="section-box">
        <!-- Include telemetry and awards -->
        {{ partial "telemetry-awards.html" (dict "appName" $name "appTrain" $train) }}
        <div class="box-image">
          <img class="app-card-img" src="{{ $appIcon }}" aria-label="{{ $appTitle }} Logo">
        </div>
        <div class="section-tab-content ixprods">
          <b class="app-title">{{ $appTitle }}</b><br>
          <a class="truenas-appbutton" href="https://www.truenas.com/docs/truenasapps/">Get Started with Apps!</a><br>
          <div class="app-info">
            <small>
              {{ if $minScaleVersion }}
                Requires TrueNAS: <b>{{ $minScaleVersion }}</b> or newer<br>
              {{ end }}
              App Version: <b>{{ $versionData.app_metadata.app_version | default "Unknown" }}</b>
              {{ if not (isset $versionData.app_metadata "app_version") }}
                {{ warnf "Missing 'app_version' in app_metadata for file: %s" $localFilePath }}
              {{ end }}
              {{ if $changelog }}
                (<a href="{{ $changelog }}" target="_blank">Changelog</a>)
              {{ else }}
                {{ warnf "No changelog_url for %s in %s" $name $localFilePath }}
              {{ end }}
              <br>
              {{ with $versionData.app_metadata.keywords }}
                Keywords: {{ delimit . ", " }}<br>
              {{ else }}
                {{ warnf "No keywords for %s in %s" $name $localFilePath }}
              {{ end }}
              Train: {{ title $train | default "Unknown" }}<br>
              {{ if $versionData.app_metadata.home }}
                Home Page: <a href="{{ $versionData.app_metadata.home }}" target="_blank">{{ $versionData.app_metadata.home }}</a><br>
              {{ else }}
                Home Page: <span style="color: #888;">N/A</span><br>
                {{ warnf "No home page for %s in %s" $name $localFilePath }}
              {{ end }}
            </small>
          </div>
        </div>
      </div>

      <!-- Second Card -->
      <div class="section-box">
        <div class="box-image">
          <b>{{ $appTitle }} Details</b><br>
          {{ if $added }}
            Added: {{ $added }}<br>
          {{ else }}
            {{ warnf "No date_added for %s in %s" $name $localFilePath }}
          {{ end }}
          {{ if $versionData.last_update }}
            Last Updated: {{ (time $versionData.last_update).Format "2006-01-02" }}<br>
          {{ else }}
            {{ warnf "No last_update for %s in %s" $name $localFilePath }}
          {{ end }}
          <p class="app-descr">
            {{ $appDescription }}
          </p>
          <!-- Context Section -->
          {{ if $versionData.app_metadata.run_as_context }}
          <b>Run as Context</b>
          <ul style="list-style-type:none;padding-left:0;">
            {{ range $run_as_context := $versionData.app_metadata.run_as_context }}
            <li>
              <small>
                {{ $run_as_context.description }}<br>
                <b>Group:</b> {{ $run_as_context.gid }} / {{ $run_as_context.group_name }}<br>
                <b>User:</b> {{ $run_as_context.uid }} / {{ $run_as_context.user_name }}
              </small>
            </li>
            {{ end }}
          </ul>
          {{ end }}
        </div>
      </div>
    </div>

    <!-- Check for deprecations -->
    {{ $deprecationsFile := "static/data/app-deprecations.yaml" }}
    {{ $deprecationsData := dict }}

    {{ if fileExists $deprecationsFile }}
      {{ $deprecationsContent := readFile $deprecationsFile }}
      {{ $deprecationsData = transform.Unmarshal $deprecationsContent | default dict }}
    {{ end }}

    {{ $pathParts := split $path "/" }}
    {{ $appName := "" }}
    {{ if ge (len $pathParts) 3 }}
      {{ $appName = index $pathParts 2 }}
    {{ end }}

    {{ $appDeprecationInfo := index $deprecationsData $appName }}

    {{ if $appDeprecationInfo }}
      {{ $currentDate := now }}
      {{ range $appDeprecationInfo.deprecations }}
        {{ $removalDate := time .removal_date }}
        {{ $daysUntilRemoval := div (sub $removalDate.Unix $currentDate.Unix) 86400 }}

        {{ $bannerClass := "partial" }}
        {{ $deprecationIcon := "‚ö†Ô∏è" }}
        {{ $bannerTitle := "Feature Deprecation Notice" }}
        {{ if eq .scope "full" }}
          {{ $bannerClass = "full" }}
          {{ $deprecationIcon = "üö®" }}
          {{ $bannerTitle = "Application Deprecation Notice" }}
        {{ end }}

        <div class="deprecation-banner {{ $bannerClass }}">
          <div class="deprecation-header">
            <span class="deprecation-icon">{{ $deprecationIcon }}</span>
            <h2>{{ $bannerTitle }}</h2>
          </div>

          {{ if eq .scope "full" }}
            <p><strong>{{ $appDeprecationInfo.title }}</strong> is deprecated and will be removed from the TrueNAS catalog.</p>
          {{ else }}
            {{ if .partial_details }}
              {{ if .partial_details.feature }}
                <p><strong>{{ $appDeprecationInfo.title }}</strong>: {{ .partial_details.feature }}</p>
              {{ else }}
                <p>A feature in <strong>{{ $appDeprecationInfo.title }}</strong> is deprecated.</p>
              {{ end }}
            {{ end }}
          {{ end }}

          <div class="deprecation-timeline">
            <p><strong>Deprecated:</strong> {{ .deprecated_date }}</p>
            <p><strong>Scheduled Removal:</strong> {{ .removal_date }}</p>
            <p class="days-remaining"><strong>Days Remaining:</strong> {{ $daysUntilRemoval }}</p>
          </div>

          {{ if .reason }}
            <p class="deprecation-reason"><strong>Reason:</strong> {{ .reason | safeHTML }}</p>
          {{ end }}

          {{ if eq .scope "partial" }}
            {{ if .partial_details }}
              {{ if .partial_details.description }}
                <div class="deprecation-timeline">
                  <p><strong>Description:</strong> {{ .partial_details.description | safeHTML }}</p>
                </div>
              {{ end }}

              {{ if .partial_details.steps }}
                <div class="migration-steps">
                  <details>
                    <summary>Migration Steps</summary>
                    <ol>
                      {{ range .partial_details.steps }}
                        <li>{{ . | safeHTML }}</li>
                      {{ end }}
                    </ol>
                  </details>
                </div>
              {{ end }}
            {{ end }}
          {{ end }}

          {{ if eq .scope "full" }}
            <p class="deprecation-action"><strong>Action Required:</strong> Please plan to migrate to an alternative solution before the removal date.</p>
          {{ else }}
            <p class="deprecation-action"><strong>Action Required:</strong> Please follow the migration steps above before the removal date.</p>
          {{ end }}
        </div>
      {{ end }}
    {{ end }}

    <!-- Screenshots Section -->
    {{ if $versionData.app_metadata.screenshots }}
      <br>
      <div class="screenshots-section">
        <b>Screenshots</b>
        <div class="screenshots-thumbnails" style="display: flex; flex-wrap: wrap; gap: 1rem;">
          {{ range $index, $screenshot := $versionData.app_metadata.screenshots }}
            <img class="screenshot-thumbnail" style="flex: 1 1 calc(33.333% - 1rem); max-width: calc(33.333% - 1rem);" src="{{ $screenshot }}" alt="Screenshot {{ add $index 1 }}" onclick="openLightbox('{{ $screenshot }}')">
          {{ end }}
        </div>
      </div>
    {{ else }}
      {{ warnf "No screenshots found for %s in %s" $name $localFilePath }}
    {{ end }}

    <!-- Lightbox Modal -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
      <span class="lightbox-close">&times;</span>
      <img id="lightbox-image" class="lightbox-content" src="" alt="Full Screenshot">
      <div class="lightbox-controls">
        <button id="prev-button" onclick="prevImage(event)">&#10094;</button>
        <button id="next-button" onclick="nextImage(event)">&#10095;</button>
      </div>
    </div>

    <!-- Host Mounts Section -->
    {{ if $versionData.app_metadata.host_mounts }}
      {{ if gt (len $versionData.app_metadata.host_mounts) 0 }}
      <br>
      <details>
        <summary>Host Mounts</summary>
        <ul>
          {{ range $host_mount := $versionData.app_metadata.host_mounts }}
          <li>
            {{ $host_mount.host_path }} : {{ $host_mount.description }}
          </li>
          {{ end }}
        </ul>
      </details>
	  {{ end }}
	{{ end }}

    <!-- Security Capabilities Section -->
    {{ if $versionData.app_metadata.capabilities }}
      {{ if gt (len $versionData.app_metadata.capabilities) 0 }}
      <br>
      <details>
        <summary>Security Capabilities</summary>
        <ul>
          {{ range $capability := $versionData.app_metadata.capabilities }}
          <li>
            {{ $capability.description }}
          </li>
          {{ end }}
        </ul>
      </details>
	  {{ end }}
	{{ end }}
    <!-- App_Versions File Expand -->
    <br>
    <details>
      <summary>App Metadata (Raw File)</summary>
      <pre><code>{{ $fileContent }}</code></pre>
    </details>
    <br>
    <hr>
  {{ end }}

{{ else }}
  <!-- File not found - check if app was removed -->
  {{ $removalsFile := "static/data/app-removals.yaml" }}
  {{ $removalsData := dict }}

  {{ if fileExists $removalsFile }}
    {{ $removalsContent := readFile $removalsFile }}
    {{ $removalsData = transform.Unmarshal $removalsContent | default dict }}
  {{ end }}

  <!-- Extract app name from path (e.g., "trains/community/codegate/app_versions.json" -> "codegate") -->
  {{ $pathParts := split $path "/" }}
  {{ $appName := "" }}
  {{ if ge (len $pathParts) 3 }}
    {{ $appName = index $pathParts 2 }}
  {{ end }}

  <!-- Check if app exists in removals data -->
  {{ $removalInfo := index $removalsData $appName }}

  {{ if $removalInfo }}
    <!-- App was removed - show removal banner -->
    <div class="deprecation-banner removed">
      <div class="removal-header">
        <span class="removal-icon">‚ùå</span>
        <h2>This app has been removed from the TrueNAS catalog</h2>
      </div>

      <p><strong>{{ $removalInfo.title }}</strong> was removed from the catalog on <strong>{{ $removalInfo.removal_detected_date }}</strong>.</p>

      {{ with $removalInfo.last_known_metadata }}
        {{ if .reason }}
          <p><strong>Reason:</strong> {{ .reason }}</p>
        {{ end }}

        {{ if .alternative_app }}
          {{ $altAppSlug := .alternative_app }}
          {{ $altAppPath := printf "/catalog/%s" $altAppSlug }}
          <p><strong>Recommended Alternative:</strong>
             <a href="{{ $altAppPath }}" class="alt-app-link">{{ $altAppSlug | title }}</a>
          </p>
        {{ end }}
      {{ end }}

      <p class="removal-note"><em>This page is maintained for historical reference and search engine indexing.</em></p>
    </div>

    <!-- Show last known app information if available -->
    {{ with $removalInfo.last_known_metadata }}
      <br>
      <div class="apps-docs-sections">
        <div class="section-box removed-app-info">
          <div class="box-image">
            {{ if .icon }}
              <img class="app-card-img" src="{{ .icon }}" aria-label="{{ $removalInfo.title }} Logo">
            {{ end }}
          </div>
          <div class="section-tab-content ixprods">
            <b class="app-title">{{ $removalInfo.title }}</b>
            <span class="removed-badge">REMOVED</span>
            <div class="app-info">
              <small>
                Train: {{ $removalInfo.train | title }}<br>
                {{ if .app_version }}
                  Last Known Version: <b>{{ .app_version }}</b><br>
                {{ end }}
                {{ if .deprecated_date }}
                  Deprecated: {{ .deprecated_date }}<br>
                {{ end }}
                Removed: {{ $removalInfo.removal_detected_date }}
              </small>
            </div>
          </div>
        </div>

        {{ if .description }}
          <div class="section-box">
            <div class="box-image">
              <b>About {{ $removalInfo.title }}</b>
              <p class="app-descr">{{ .description }}</p>
              <p class="last-known-note"><small><em>This information reflects the app's last known state before removal.</em></small></p>
            </div>
          </div>
        {{ end }}
      </div>
    {{ end }}

  {{ else }}
    <!-- App not in removals data - show error -->
    <p>Error: File not found at <code>{{ $localFilePath }}</code>.</p>
    {{ warnf "File not found at %s" $localFilePath }}
  {{ end }}
{{ end }}